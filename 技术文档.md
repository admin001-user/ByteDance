# 技术设计文档 (Technical Design Report)
本项目是一款基于 Android 平台的高性能短视频应用，采用现代化的 **MVVM 架构**，深度复刻了主流短视频应用的核心体验。项目实现了沉浸式全屏播放、双列瀑布流、互动评论、个人中心等核心功能，并针对视频播放流畅度、内存管理及用户交互进行了深度优化。
## 一、双列外流 (Double Column Feed)

*   **双列外流的UI布局**：
    *   使用 `RecyclerView` 配合 `StaggeredGridLayoutManager` (2列) 实现瀑布流布局。
    *   Item 布局包含封面图（使用 Glide 加载）、视频描述文案、点赞数、作者信息。
    *   卡片设计采用圆角与阴影 (`CardView`)，提升视觉效果。
*   **点击封面进入视频内流**：
    *   实现 `VideoAdapter` 的点击监听接口。
    *   点击 Item 跳转至 `PlayerActivity`，通过 Intent 传递当前视频列表数据 (`ArrayList<VideoItem>`) 与起始位置 (`start_position`)。
*   **进入视频内流有画面放大的转场动画**：
    *   使用 Android 5.0+ 的 `ActivityOptionsCompat.makeSceneTransitionAnimation` 实现共享元素转场（Shared Element Transition）。
    *   封面图作为共享元素，从列表位置平滑放大至全屏播放页背景。
*   **每个卡片页面高度自适应布局**：
    *   根据图片原始宽高比动态计算 Item 高度，确保瀑布流错落有致，避免布局留白或拉伸。
*   **下拉刷新，上拉加载更新数据**：
    *   集成 `SwipeRefreshLayout` 实现下拉刷新，重置列表数据。
    *   监听 `RecyclerView` 滚动状态，当滑动到底部时自动触发“加载更多”逻辑，模拟分页请求。
*   **顶部和底部bar实现，支持切换**：
    *   底部导航栏使用自定义 View 或 `BottomNavigationView`，支持“首页”、“朋友”、“消息”、“我”等 Tab 切换。
    *   顶部使用 `TabLayout` + `ViewPager2` 切换“关注”与“推荐”分类。

## 二、视频内流 (Video Inner Flow)

*   **内流页面布局**：
    *   全屏沉浸式布局，使用 `FrameLayout` 叠加视频层 (`PlayerView`) 与交互层 (点赞、评论、进度条等)。
    *   背景层使用高斯模糊的封面图 (`BlurTransformation`)，在视频加载前提供视觉填充，防止黑屏。
*   **点击暂停、播放**：
    *   实现 `GestureDetector` 监听单击事件：切换播放/暂停状态。
    *   暂停时显示中心播放图标（带缩放淡入淡出动画），播放时自动隐藏。
*   **手指上下移动、切换**：
    *   使用 **`ViewPager2`** (Orientation=VERTICAL) 实现抖音式的整页滑动切换。
    *   **进阶优化**：实现 **视频预加载** (Preloading)。在 `onPageSelected` 中启动后台线程，利用 ExoPlayer `CacheDataSource` 预缓存后续 3 个视频的前 2MB 数据，确保滑动即播（秒开体验）。
*   **双击点赞动画**：
    *   监听双击事件 (`onDoubleTap`)，在触摸位置动态生成红心图标。
    *   执行 缩放(Scale) + 透明度(Alpha) + 位移(Translation) 的组合动画，模拟抖音点赞效果。
*   **音乐转盘和动画**：
    *   右下角音乐唱片图标，使用 `ObjectAnimator` 实现无限旋转动画。
    *   与播放状态联动：视频播放时旋转，暂停时停止。
*   **下拉刷新，上拉加载更新数据**：
    *   在 ViewPager2 第一页支持下拉刷新重置列表。
    *   滑至列表倒数第3项时自动触发预加载更多数据。
*   **支持头像更换**：
    *   点击右侧头像跳转个人中心 (`ProfileActivity`)。
    *   个人中心支持调用系统相机或图库裁剪更新头像（需处理权限适配）。

## 三、评论页面 (Comment Page)

*   **评论UI布局**：
    *   使用 `BottomSheetDialogFragment` 实现底部弹出面板，支持手势拖拽关闭。
    *   布局结构：顶部标题栏（显示评论数、关闭按钮）+ 中间 `RecyclerView` 评论列表 + 底部固定输入框。
*   **评论页面高度自适应布局**：
    *   动态计算屏幕高度，设置面板高度为屏幕的 70%。
    *   **关键修复**：使用 `RelativeLayout` 或 `ConstraintLayout` 确保列表高度正确适应，避免输入框遮挡列表底部。
*   **支持发布新评论并展示最顶部**：
    *   输入框监听文字变化，动态更新“发送”按钮状态。
    *   点击发送：构建 `Comment` 对象 -> 插入列表位置 0 -> `notifyItemInserted(0)` -> 列表滚动至顶部 -> 清空输入框 -> 收起键盘。
*   **交互优化（点击评论回复）**：
    *   **功能实现**：点击某条评论，自动填充 "回复 @用户名: " 到输入框。
    *   **技术细节**：通过 `OnCommentClickListener` 接口回调，在 Fragment 中处理点击事件，并自动弹出软键盘 (`InputMethodManager.SHOW_IMPLICIT`)。

## 四、功能实现思路与难点 (Challenges & Solutions)

### 1. 视频流的流畅性与内存优化
*   **难点**：`ViewPager2` 滑动过程中频繁创建/销毁播放器会导致卡顿，且网络加载会有黑屏。
*   **解决方案**：
    *   **全局单例 Cache**：使用 ExoPlayer 的 `SimpleCache` (100MB) 避免重复下载。
    *   **预加载机制**：在 `onPageSelected` 中启动后台线程预加载后续视频。
    *   **TextureView**：配置 `app:surface_type="texture_view"`，相比 SurfaceView 更适合在 ViewPager 中滑动，减少黑屏闪烁。
    *   **首帧渲染优化**：监听 `onRenderedFirstFrame`，在首帧渲染前保持封面图可见，渲染后隐藏封面图，彻底解决滑动黑屏问题。

### 2. 进度条与手势冲突
*   **难点**：播放器自动更新进度条（每秒多次）与用户手动拖拽进度条产生冲突，导致滑块跳动。
*   **解决方案**：引入 `isDragging` 状态位。
    *   `onStartTrackingTouch` -> `isDragging = true` (停止自动更新)。
    *   `onStopTrackingTouch` -> `isDragging = false` (恢复更新)，并强制调用 `player.play()` 确保松手即播。

### 3. 评论区软键盘适配
*   **难点**：底部弹窗中，软键盘弹出往往会遮挡输入框。
*   **解决方案**：
    *   设置 `dialog.getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE)`。
    *   确保根布局能够响应尺寸变化，将输入框顶起。

### 4. 复杂动画交互
*   **关注按钮**：实现 "加号 -> 对号 -> 消失" 的三阶段状态机动画。
*   **点赞**：结合 `ObjectAnimator` 和 `ScaleX/Y` 实现心跳效果。

## 五、类图设计 (Summary Class Diagram)

*   **PlayerActivity**: 核心控制器 (Controller)，管理 `ViewPager2` 和 `ExoPlayer` 实例，处理视频播放逻辑、手势交互与生命周期。
*   **VideoPlayerAdapter**: 视图适配器 (View Adapter)，绑定 `VideoItem` 数据到 `PlayerView`，管理每个页面的 UI 元素（点赞、评论按钮等）。
*   **CommentPanelFragment**: 评论区控制器，继承自 `BottomSheetDialogFragment`，管理评论数据的展示与交互 (MVC 中的 Controller)。
*   **CommentAdapter**: 评论列表适配器，处理评论项的渲染与点击回调。
*   **VideoItem / Comment**: 数据模型 (Model)，POJO 类。
*   **ByteDanceApplication**: 全局环境，负责初始化视频缓存配置 (`SimpleCache`)。

---
